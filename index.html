<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas Fiscais e Checklist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --bg-body: #f8fafc; --surface: #ffffff;
            --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
            --fiscal-color: #b45309; --fiscal-bg: #fffbeb; 
            --compras-color: #b91c1c; --compras-bg: #fef2f2; 
            --almox-color: #1d4ed8; --almox-bg: #eff6ff;      
            --aprov-color: #047857; --aprov-bg: #ecfdf5;      
            --kpi-header-bg: #b91c1c;
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { background: linear-gradient(to right, #ffffff, #f1f5f9); padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); z-index: 10; flex-shrink: 0; }
        .header-left h1 { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        .header-actions { display: flex; gap: 1rem; align-items: center; }

        .add-btn, .nav-btn, .excel-btn, .pdf-btn, .reset-btn, .btn-xml { border: none; height: 40px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: var(--shadow-md); font-weight: 700; padding: 0 16px; font-size: 0.8rem; }
        .add-btn { background-color: var(--primary); color: white; width: 40px; padding: 0; }
        .nav-btn { background-color: #1e293b; color: white; }
        .excel-btn { background-color: #107c41; color: white; gap: 8px; }
        .btn-xml { background-color: #f59e0b; color: white; width: 40px; padding: 0; }
        .pdf-btn { background-color: white; border: 1px solid var(--border); color: var(--text-main); gap: 6px; box-shadow: none; }
        .reset-btn { background-color: #fee2e2; border: 1px solid #fecaca; color: #b91c1c; gap: 6px; box-shadow: none; }

        .main-content { flex: 1; padding: 1.5rem; overflow-y: hidden; display: flex; flex-direction: column; gap: 1.5rem; }
        .card-bubble { background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-md); border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        
        .table-wrapper { flex: 1; min-height: 0; }
        .table-scroll { overflow: auto; width: 100%; height: 100%; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        thead { background-color: #f8fafc; position: sticky; top: 0; z-index: 5; }
        th { text-align: left; padding: 12px 16px; font-weight: 800; color: var(--text-main); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; white-space: nowrap; border-bottom: 2px solid var(--border); vertical-align: bottom; }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); white-space: nowrap; }
        td.text-long-col { white-space: nowrap; max-width: none; }
        tbody tr:hover { background-color: #f1f5f9; }
        th:nth-child(1) { width: 90px; text-align: center; } 
        td:nth-child(1) { text-align: center; }

        /* DASHBOARD LAYOUT */
        .dashboard-container { height: 220px; min-height: 220px; padding: 1.5rem 3rem; display: flex; flex-direction: row; align-items: center; justify-content: flex-start; gap: 4rem; flex-shrink: 0; }
        .chart-box { position: relative; height: 170px; width: 170px; flex-shrink: 0; }
        .stats-box { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; align-content: center; height: 100%; }
        .stat-item { padding: 1rem; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 4px; background: white; height: 100px; justify-content: center; min-width: 150px; }
        .stat-label { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        .stat-count { font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .stat-value { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
        .stat-fiscal { border-left: 5px solid var(--fiscal-color); background: var(--fiscal-bg); } .stat-fiscal .stat-count { color: var(--fiscal-color); }
        .stat-compras { border-left: 5px solid var(--compras-color); background: var(--compras-bg); } .stat-compras .stat-count { color: var(--compras-color); }
        .stat-almoxarifado { border-left: 5px solid var(--almox-color); background: var(--almox-bg); } .stat-almoxarifado .stat-count { color: var(--almox-color); }
        .stat-aprovacao { border-left: 5px solid var(--aprov-color); background: var(--aprov-bg); } .stat-aprovacao .stat-count { color: var(--aprov-color); }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
        .bg-fiscal { background: var(--fiscal-bg); color: var(--fiscal-color); border: 1px solid #fcd34d; }
        .bg-compras { background: var(--compras-bg); color: var(--compras-color); border: 1px solid #fecaca; }
        .bg-almox { background: var(--almox-bg); color: var(--almox-color); border: 1px solid #bfdbfe; }
        .bg-aprov { background: var(--aprov-bg); color: var(--aprov-color); border: 1px solid #a7f3d0; }
        .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border: 1px solid transparent; }
        .status-pill.pending { background-color: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .status-pill.completed { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .icon-btn { border: none; background: transparent; color: var(--text-muted); cursor: pointer; padding: 6px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center; }
        .icon-btn:hover { background-color: #f1f5f9; color: var(--primary); } .icon-btn.delete:hover { background-color: #fee2e2; color: #dc2626; }
        .drag-handle { cursor: move !important; cursor: -webkit-grabbing; color: #94a3b8; padding: 6px; margin-right: 2px; }
        .drag-handle:hover { color: var(--text-main); background-color: #e2e8f0; border-radius: 6px; }
        .drag-handle:active { cursor: grabbing; color: var(--primary); }
        .sortable-ghost { opacity: 0.4; background-color: #f1f5f9; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-md); width: 95%; max-height: 95vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: transparent; border: none; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; transition: background 0.2s; }
        .close-btn:hover { background-color: #f1f5f9; color: var(--text-main); }
        .close-btn span { font-size: 24px; }

        #formModalBody { max-width: 900px; margin: 0 auto; }
        .modal-body { padding: 2rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .input-field { padding: 10px; border: 1px solid var(--border); border-radius: 8px; width: 100%; outline: none; }
        .form-footer { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        .kpi-modal-container { width: 98%; max-width: none; margin: 1rem; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; padding: 1.5rem; background: #f1f5f9; }
        .kpi-column { display: flex; flex-direction: column; gap: 1rem; }
        .kpi-table-wrapper { background: white; border: 2px solid #000; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .kpi-header-row { background-color: var(--kpi-header-bg); color: white; padding: 8px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
        .kpi-count-badge { background: white; color: var(--kpi-header-bg); padding: 2px 8px; border-radius: 4px; font-weight: 800; }
        .kpi-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .kpi-table th { background-color: #cbd5e1; border: 1px solid #000; color: #000; padding: 6px; text-align: center; font-weight: 700; font-size: 0.75rem; }
        .kpi-table td { border: 1px solid #000; padding: 6px; text-align: center; color: #000; font-weight: 600; }
        .kpi-row-fiscal { background-color: #fff; }
        .kpi-row-grey { background-color: #e2e8f0; }
        .kpi-manual-input { width: 100%; border: none; background: transparent; text-align: center; font-weight: 600; outline: none; color: #b91c1c; height: 100%; box-sizing: border-box; padding: 5px 0; display: block; }
        .kpi-badge-input { background: white; color: var(--kpi-header-bg); border: none; border-radius: 4px; font-weight: 800; width: 40px; text-align: center; outline: none; font-size: 0.9rem; padding: 2px; }
        .red-text { color: #b91c1c; font-weight: 800; }

        .services-modal-body { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .services-table-wrapper { overflow: auto; border: 2px solid #b91c1c; max-height: 55vh; border-radius: 8px 8px 0 0; }
        .services-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1600px; }
        .services-table th { background-color: var(--kpi-header-bg); color: white; font-weight: 800; padding: 8px; border: 1px solid #000; text-transform: uppercase; font-size: 0.75rem; white-space: nowrap; vertical-align: top; position: sticky; top: 0; z-index: 10; }
        .filter-input { display: block; width: 100%; margin-top: 4px; padding: 4px; font-size: 0.7rem; border: none; border-radius: 4px; color: #333; background: rgba(255, 255, 255, 0.9); box-sizing: border-box; }
        .services-table td { border: 1px solid #000; padding: 0; background: white; height: 36px; }
        .svc-input { width: 100%; height: 100%; padding: 0 8px; border: none; outline: none; font-size: 0.85rem; background: transparent; }
        .svc-select { display: block; width: 100%; height: 100%; border: none; outline: none; border-radius: 0; font-size: 0.7rem; font-weight: 800; text-align: center; text-transform: uppercase; appearance: none; cursor: pointer; padding: 0; margin: 0; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 4px center; background-size: 10px; }
        .svc-select option { background-color: white !important; color: #1e293b !important; font-weight: normal; }
        .st-red { background: #fee2e2; color: #b91c1c; } .st-green { background: #dcfce7; color: #166534; } .st-blue { background: #eff6ff; color: #1d4ed8; } .st-yellow { background: #fffbeb; color: #b45309; }

        .dash-checklist-container { display: flex; gap: 2rem; align-items: center; margin-top: 10px; background: #fff; padding: 1rem; border-radius: 12px; border: 1px solid var(--border); }
        .checklist-stats-grid { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .dash-card-check { height: 80px; padding: 0.8rem; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; }
        .dash-check-total { border-left: 5px solid #1e293b; background: #f8fafc; }
        .dash-check-rec { border-left: 5px solid #166534; background: #dcfce7; } .dash-check-rec .cnt { color: #166534; }
        .dash-check-pen { border-left: 5px solid #b91c1c; background: #fee2e2; } .dash-check-pen .cnt { color: #b91c1c; }
        .dash-check-nop { border-left: 5px solid #1d4ed8; background: #eff6ff; } .dash-check-nop .cnt { color: #1d4ed8; }
        .cnt { font-size: 1.4rem; font-weight: 800; margin-top: 4px; }
        .lbl { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; }

        .add-row-btn-container { display: flex; justify-content: center; padding: 10px; }
        .btn-plus-row { background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: var(--shadow-md); }
        .xml-textarea { width: 100%; height: 200px; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.85rem; resize: vertical; }
        .notes-textarea { width: 100%; height: 400px; padding: 1.5rem; border: none; outline: none; font-size: 1rem; line-height: 1.6; resize: none; background: #fafafa; }
        .checklist-date-input { background: transparent; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px 8px; font-size: 1rem; color: #1e293b; font-weight: 600; width: 200px; }
        .error-modal { border-left: 5px solid #b91c1c; }
        .error-icon { color: #b91c1c; background: #fee2e2; width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; margin: 0 auto; }
        .confirm-modal { max-width: 400px; text-align: center; padding: 2rem; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .confirm-modal h3 { margin-top: 1rem; color: #1e293b; }
        .confirm-modal p { color: #64748b; margin-bottom: 2rem; }
        .confirm-actions { display: flex; gap: 10px; justify-content: center; }

        #loading-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        #error-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fee2e2; color: #b91c1c; padding: 15px; text-align: center; font-weight: bold; z-index: 10000; border-bottom: 2px solid #b91c1c; }
    </style>
</head>
<body>

    <div id="error-banner"></div>
    <div id="loading-screen"><h2>Carregando sistema...</h2><p id="loading-text">Conectando ao banco de dados...</p></div>

    <header>
        <div class="header-left">
            <h1>Notas Fiscais para Correção</h1>
        </div>
        <div class="header-actions">
            <button class="nav-btn btn-xml" title="Importar XML" onclick="openXMLModal()">
                <span class="material-icons-round">description</span>
            </button>
            <button class="nav-btn excel-btn" onclick="exportMainExcel()">
                <span class="material-icons-round" style="font-size: 18px;">table_view</span>
                EXPORTAR EXCEL
            </button>
            <button class="nav-btn" onclick="openConsideracoes()">CONSIDERAÇÕES</button>
            <button class="nav-btn" onclick="openServicesModal()">CHECKLIST</button>
            <button class="nav-btn" onclick="openKPIModal()">KPI</button>
            <button id="btnNovo" class="add-btn" title="Adicionar Nova Nota">
                <span class="material-icons-round">add</span>
            </button>
        </div>
    </header>

    <div class="main-content">
        <div class="card-bubble table-wrapper">
            <div class="table-scroll">
                <table id="nfTable">
                    <thead>
                        <tr>
                            <th>Ações</th><th>Status</th><th>Setor</th><th>Tipo de NF</th><th>Fornecedor</th><th>Pedido</th><th>Linha</th><th>Valor</th><th>Emissão</th><th>Inclusão</th><th>Vencimento</th><th>Ref.</th><th>Chave</th><th>Resp.</th><th>Erro</th><th>Obs. Correção</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card-bubble dashboard-container">
            <div class="chart-box"><canvas id="sectorChart"></canvas></div>
            <div class="stats-box" id="statsBox"></div>
        </div>
    </div>

    <div class="modal-overlay" id="xmlModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header"><h2>Importar XML</h2><button class="close-btn" onclick="closeXMLModal()"><span>&times;</span></button></div>
            <div class="modal-body"><textarea id="xmlInput" class="xml-textarea" placeholder="Cole o XML aqui..."></textarea></div>
            <div class="form-footer"><button class="btn-primary" onclick="processXML()">Processar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="notesModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header"><h2>Considerações Gerais</h2><button class="close-btn" onclick="closeNotesModal()"><span>&times;</span></button></div>
            <textarea id="notesArea" class="notes-textarea"></textarea>
            <div class="form-footer"><span id="notesStatus" style="color:green;margin-right:auto;"></span><button class="btn-primary" onclick="saveNotes()">Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="kpiModal">
        <div class="modal kpi-modal-container">
            <div class="modal-header">
                <h2>Indicadores de Performance (KPI)</h2>
                <div style="display:flex;gap:10px;">
                    <button class="pdf-btn" onclick="exportKPIPDF()"><span class="material-icons-round" style="font-size:16px">picture_as_pdf</span> EXPORTAR PDF</button>
                    <button class="close-btn" onclick="closeKPIModal()"><span>&times;</span></button>
                </div>
            </div>
            <div class="kpi-grid" id="kpiContent">
                <div class="kpi-column" id="colMercadoria"></div>
                <div class="kpi-column">
                    <div class="kpi-table-wrapper"><div class="kpi-header-row">INFORMAÇÕES COMPLEMENTARES</div><table class="kpi-table"><tr><th>MIGO SEM MIRO</th><th>NOTAS RECUSADAS</th></tr><tr><td style="height:40px;"><input type="number" class="kpi-manual-input" value="0"></td><td><input type="text" class="kpi-manual-input" value="-"></td></tr><tr><td colspan="2" style="background:#ccc;text-align:left;padding-left:10px;">Fornecedor(es): <input type="text" class="kpi-manual-input" style="width:60%;text-align:left;" value="-"></td></tr></table></div>
                    <div class="kpi-table-wrapper"><div class="kpi-header-row">NOTAS DE SERVIÇO CHECKLIST<span class="kpi-count-badge" id="kpiChecklistCount" style="background:white;color:#b91c1c;padding:2px 10px;border-radius:4px;font-weight:800;">0</span></div><table class="kpi-table"><tr><th>PRESTADOR</th><th>RESPONSÁVEL</th><th>PRESTADOR</th><th>RESPONSÁVEL</th></tr><script>for(let i=0;i<10;i++) document.write(`<tr><td><input class="kpi-manual-input"></td><td><input class="kpi-manual-input"></td><td><input class="kpi-manual-input"></td><td><input class="kpi-manual-input"></td></tr>`)</script></table></div>
                </div>
                <div class="kpi-column" id="colServico"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="servicesModal">
        <div class="modal kpi-modal-container">
            <div class="modal-header">
                <div style="display: flex; gap: 1rem; align-items: center;"><h2>Checklist de serviços fixos</h2><input type="text" id="checklistDate" class="checklist-date-input" placeholder="Mês/Ano" onchange="saveChecklistDate(this.value)"></div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="reset-btn" onclick="openResetModal()"><span class="material-icons-round" style="font-size:16px">restart_alt</span> RESETAR</button>
                    <button class="pdf-btn" onclick="exportServicesPDF()"><span class="material-icons-round" style="font-size:16px">picture_as_pdf</span> EXPORTAR PDF</button>
                    <button class="close-btn" onclick="closeServicesModal()"><span>&times;</span></button>
                </div>
            </div>
            
            <div class="services-modal-body" id="checklistBody">
                <div class="services-table-wrapper">
                    <table class="services-table" id="svcTable">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>FORN.<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(1, this.value)"></th>
                                <th>TIPO<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(2, this.value)"></th>
                                <th style="width: 140px;">ENVIO NF<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(3, this.value)"></th>
                                <th style="width: 140px;">STATUS PO<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(4, this.value)"></th>
                                <th>RESP<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(5, this.value)"></th>
                                <th>SETOR<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(6, this.value)"></th>
                                <th>COD<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(7, this.value)"></th>
                                <th>CONTA<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(8, this.value)"></th>
                                <th>PED<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(9, this.value)"></th>
                                <th>OBS<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(10, this.value)"></th>
                                <th>SAP<input class="filter-input" placeholder="Filtro..." onkeyup="filterServices(11, this.value)"></th>
                            </tr>
                        </thead>
                        <tbody id="svcTableBody"></tbody>
                    </table>
                </div>
                <div class="add-row-btn-container"><button class="btn-plus-row" onclick="addServiceRow()">+</button></div>

                <div class="dash-checklist-container">
                    <div style="width: 120px; position: relative; height: 120px; flex-shrink:0;">
                        <canvas id="checkChart"></canvas>
                    </div>
                    <div class="checklist-stats-grid">
                        <div class="dash-card-check dash-check-total"><span class="lbl">TOTAL</span><span class="cnt" id="chkTotal">0</span></div>
                        <div class="dash-card-check dash-check-rec"><span class="lbl">RECEBIDAS</span><span class="cnt" id="chkRec">0</span></div>
                        <div class="dash-card-check dash-check-pen"><span class="lbl">PENDENTES</span><span class="cnt" id="chkPen">0</span></div>
                        <div class="dash-card-check dash-check-nop"><span class="lbl">SEM EMISSÃO</span><span class="cnt" id="chkNop">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="resetModal"><div class="modal" style="max-width:400px;text-align:center;padding:2rem;"><h3>Resetar Checklist?</h3><p style="color:#64748b;margin:10px 0;">Isso mudará todos os status para "PENDENTE".</p><input type="password" id="resetPassword" class="input-field" style="margin:1rem 0;text-align:center;" placeholder="Senha..."><div style="display:flex;gap:10px;justify-content:center;"><button class="btn-ghost" onclick="closeResetModal()">Cancelar</button><button class="btn-primary" onclick="confirmReset()">Confirmar</button></div></div></div>

    <div class="modal-overlay" id="errorModal"><div class="modal error-modal" style="max-width:350px;text-align:center;padding:2rem;"><div class="error-icon"><span class="material-icons-round" style="font-size:30px">error_outline</span></div><h3 style="margin-top:1rem;color:#b91c1c;">Senha Incorreta</h3><p style="color:#64748b;margin-bottom:1.5rem;">A senha informada não confere.</p><button class="btn-primary" onclick="document.getElementById('errorModal').classList.remove('active')">Tentar Novamente</button></div></div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="formModalBody">
            <div class="modal-header"><h2 id="modalTitle">Nota</h2><button class="close-btn" onclick="closeModal()"><span>&times;</span></button></div>
            <form id="nfForm">
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="form-grid">
                        <div class="form-group"><label>Setor</label><select id="setor" class="input-field" required><option value="FISCAL">FISCAL</option><option value="COMPRAS">COMPRAS</option><option value="ALMOXARIFADO">ALMOXARIFADO</option><option value="APROVAÇÃO">APROVAÇÃO</option></select></div>
                        <div class="form-group"><label>Tipo</label><select id="tipo" class="input-field" required><option value="MERCADORIA">MERCADORIA</option><option value="SERVIÇO">SERVIÇO</option><option value="CTE">CTE</option></select></div>
                        <div class="form-group"><label>Fornecedor</label><input type="text" id="fornecedor" class="input-field" required></div>
                        <div class="form-group"><label>Pedido</label><input type="text" id="pedido" class="input-field"></div>
                        <div class="form-group"><label>Linha</label><input type="text" id="linhaPedido" class="input-field"></div>
                        <div class="form-group"><label>Valor (R$)</label><input type="text" id="valor" class="input-field" required></div>
                        <div class="form-group"><label>Emissão</label><input type="date" id="dataEmissao" class="input-field" required></div>
                        <div class="form-group"><label>Inclusão</label><input type="date" id="dataInclusao" class="input-field"></div>
                        <div class="form-group"><label>Vencimento</label><input type="date" id="dataVencimento" class="input-field"></div>
                        <div class="form-group"><label>Ref.</label><input type="text" id="referencia" class="input-field"></div>
                        <div class="form-group" style="grid-column: span 2;"><label>Chave</label><input type="text" id="chave" class="input-field"></div>
                        <div class="form-group"><label>Resp.</label><input type="text" id="respCorrecao" class="input-field"></div>
                        <div class="form-group" style="grid-column: span 2;"><label>Erro</label><textarea id="obsErro" rows="2" class="input-field"></textarea></div>
                        <div class="form-group" style="grid-column: span 2;"><label>Correção</label><textarea id="obsCorrecao" rows="2" class="input-field"></textarea></div>
                    </div>
                    <div class="form-footer"><button type="button" class="btn-ghost" onclick="closeModal()">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal confirm-modal">
            <div class="icon-circle"><span class="material-icons-round">delete_forever</span></div>
            <h3 class="confirm-title">Excluir Linha?</h3>
            <p class="confirm-text">Tem certeza que deseja remover esta linha permanentemente?</p>
            <div class="confirm-actions">
                <button class="btn-ghost" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn-danger" onclick="confirmDeleteRow()">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP INICIAL SEGURO ---
        const SUPABASE_URL = 'https://ucbkpyozkcxukpqehnxs.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjYmtweW96a2N4dWtwcWVobnhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODQ0MzAsImV4cCI6MjA4MDc2MDQzMH0.GIMpplCcy7Qj0jVXP65Ba_xprBbwrbP2WmR8138sL1w';
        let supabase;
        let nfs = [], servicesData = [], chartInstance = null, checklistChartInstance = null, itemToDeleteId = null, isDeletingService = false;

        // Função para mostrar erros na tela
        function showError(msg) {
            const banner = document.getElementById('error-banner');
            banner.style.display = 'block';
            banner.innerText = "ERRO: " + msg;
            console.error(msg);
            document.getElementById('loading-screen').style.display = 'none';
        }

        // --- 2. INICIALIZAÇÃO BLINDADA ---
        window.onload = async function() {
            try {
                if (typeof window.supabase === 'undefined') throw new Error("Supabase não carregou (Erro de Rede).");
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Timeout de segurança: Se o banco não responder em 5s, avisa erro
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Tempo limite excedido. Verifique sua internet.")), 8000)
                );

                await Promise.race([loadData(), timeoutPromise]);

                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen').style.display = 'none', 500);

            } catch (err) {
                showError(err.message);
            }
        };

        async function loadData() {
            try {
                // Tenta carregar notas (Primeiro com ordem, se falhar, sem ordem)
                let { data: nData, error } = await supabase.from('notas').select('*').order('ordem', {ascending: true, nullsFirst: false}).order('created_at', {ascending: false});
                
                if (error) {
                    console.warn("Erro de ordenação, tentando fallback...");
                    const fallback = await supabase.from('notas').select('*').order('created_at', {ascending: false});
                    if (fallback.error) throw fallback.error;
                    nData = fallback.data;
                }

                if (nData) {
                    nfs = nData;
                    renderTable();
                }

                // Tenta carregar Checklist (independente das notas)
                const sData = await supabase.from('servicos').select('*').order('created_at', {ascending:true});
                if(sData.data) servicesData = sData.data;

                // Tenta carregar Config
                const cData = await supabase.from('checklist_config').select('titulo_data').eq('id', 1).single();
                if(cData.data) document.getElementById('checklistDate').value = cData.data.titulo_data;

            } catch (err) {
                throw new Error("Falha no Banco de Dados: " + err.message);
            }
        }

        function setupRealtime() {
            if(!supabase) return;
            supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'notas' }, () => loadData())
            .on('postgres_changes', { event: '*', schema: 'public', table: 'servicos' }, async () => {
                const { data } = await supabase.from('servicos').select('*').order('created_at', {ascending:true});
                if(data) servicesData = data;
                if(document.getElementById('servicesModal').classList.contains('active')) {
                    renderServicesTable(); updateChecklistDashboard();
                }
            })
            .subscribe();
        }
        setupRealtime();

        // --- FUNÇÕES DE MODAL ---
        function openKPIModal() { calculateKPIs(); document.getElementById('kpiModal').classList.add('active'); }
        function closeKPIModal() { document.getElementById('kpiModal').classList.remove('active'); }
        
        async function openServicesModal() { 
            document.getElementById('servicesModal').classList.add('active'); 
            // Recarrega dados para garantir
            const { data } = await supabase.from('servicos').select('*').order('created_at', {ascending:true});
            if(data) servicesData = data;
            renderServicesTable(); 
            updateChecklistDashboard(); 
        }
        function closeServicesModal() { document.getElementById('servicesModal').classList.remove('active'); }
        
        function openXMLModal() { document.getElementById('xmlModal').classList.add('active'); }
        function closeXMLModal() { document.getElementById('xmlModal').classList.remove('active'); document.getElementById('xmlInput').value = ''; }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }
        
        function openResetModal() { document.getElementById('resetModal').classList.add('active'); }
        function closeResetModal() { document.getElementById('resetModal').classList.remove('active'); document.getElementById('resetPassword').value = ''; }
        
        function openDeleteModal(index, svc) { if(svc) { itemToDeleteId = servicesData[index].id; isDeletingService = true; } else { itemToDeleteId = nfs[index].id; isDeletingService = false; } document.getElementById('deleteModal').classList.add('active'); }
        
        async function confirmDeleteRow() { const tbl = isDeletingService ? 'servicos' : 'notas'; await supabase.from(tbl).delete().eq('id', itemToDeleteId); if(isDeletingService) { servicesData = servicesData.filter(s=>s.id!==itemToDeleteId); renderServicesTable(); updateChecklistDashboard(); } else { nfs = nfs.filter(n=>n.id!==itemToDeleteId); renderTable(); } closeDeleteModal(); }
        async function confirmReset() { if(document.getElementById('resetPassword').value === 'Aht2025') { await supabase.from('servicos').update({ envio_nf: 'PENDENTE', status_po: 'PENDENTE' }).neq('id', 0); loadData().then(() => { renderServicesTable(); updateChecklistDashboard(); closeResetModal(); }); } else { closeResetModal(); document.getElementById('errorModal').classList.add('active'); } }

        function updateChecklistDashboard() {
            const ctx = document.getElementById('checkChart').getContext('2d');
            if(checklistChartInstance) checklistChartInstance.destroy();
            
            const normalize = (str) => str ? str.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
            const total = servicesData.length;
            const received = servicesData.filter(s => normalize(s.envio_nf).includes('RECEBIDO')).length;
            const pending = servicesData.filter(s => normalize(s.envio_nf).includes('PENDENTE')).length;
            const notDone = servicesData.filter(s => normalize(s.envio_nf).includes('NAO PRESTADO')).length;

            document.getElementById('chkTotal').innerText = total;
            document.getElementById('chkRec').innerText = received;
            document.getElementById('chkPen').innerText = pending;
            document.getElementById('chkNop').innerText = notDone;

            checklistChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Rec', 'Pen', 'Não'], datasets: [{ data: [received, pending, notDone], backgroundColor: ['#166534', '#b91c1c', '#1d4ed8'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: {display: false} } } });
        }

        async function exportServicesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const dateTitle = document.getElementById('checklistDate').value || 'Geral';
            doc.setFontSize(14);
            doc.text(`Checklist de Serviços Fixos - ${dateTitle}`, 14, 15);
            const tableColumn = ["FORN.", "TIPO", "ENVIO NF", "STATUS PO", "RESP", "SETOR", "COD", "CONTA", "PED", "OBS", "SAP"];
            const tableRows = [];
            const trs = document.querySelectorAll('#svcTableBody tr');
            trs.forEach(tr => {
                if (tr.style.display !== 'none') {
                    const inputs = tr.querySelectorAll('input, select');
                    if (inputs.length > 0) {
                        const rowData = [
                            inputs[0].value, inputs[1].value, inputs[2].value, inputs[3].value,
                            inputs[4].value, inputs[5].value, inputs[6].value, inputs[7].value,
                            inputs[8].value, inputs[9].value, inputs[10].value
                        ];
                        tableRows.push(rowData);
                    }
                }
            });
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 20, theme: 'grid',
                styles: { fontSize: 7, cellPadding: 2, valign: 'middle' },
                headStyles: { fillColor: [185, 28, 28], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: { cellWidth: 35 }, 9: { cellWidth: 40 } },
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        if (data.column.index === 2 || data.column.index === 3) {
                            const text = (data.cell.raw || '').toString().toUpperCase();
                            if (text.includes('PENDENTE') || text.includes('CORREÇÃO')) {
                                data.cell.styles.fillColor = [254, 226, 226]; data.cell.styles.textColor = [185, 28, 28];
                            } else if (text.includes('RECEBIDO') || text.includes('LANÇADO')) {
                                data.cell.styles.fillColor = [220, 252, 231]; data.cell.styles.textColor = [22, 101, 52];
                            } else if (text.includes('NÃO PRESTADO')) {
                                data.cell.styles.fillColor = [239, 246, 255]; data.cell.styles.textColor = [29, 78, 216];
                            } else if (text.includes('APROVAÇÃO')) {
                                data.cell.styles.fillColor = [255, 251, 235]; data.cell.styles.textColor = [180, 83, 9];
                            }
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                }
            });
            doc.save(`checklist_${dateTitle.replace('/','-')}.pdf`);
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            nfs.forEach((nf, index) => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', nf.id);
                let badgeClass = 'bg-fiscal'; if(nf.setor) { const s = nf.setor.trim().toUpperCase(); if(s==='COMPRAS') badgeClass='bg-compras'; else if(s==='ALMOXARIFADO') badgeClass='bg-almox'; else if(s==='APROVAÇÃO') badgeClass='bg-aprov'; }
                const stClass = nf.corrigido ? 'completed' : 'pending'; const stText = nf.corrigido ? 'CORRIGIDO' : 'PENDENTE'; const stIcon = nf.corrigido ? 'check_circle' : 'lock';
                
                const dragHandle = `<span class="material-icons-round drag-handle" title="Arrastar">drag_handle</span>`;
                
                tr.innerHTML = `<td><div class="actions-cell" style="display:flex;align-items:center;gap:4px;">${dragHandle}<button class="icon-btn" onclick="editRow(${index})"><span class="material-icons-round">edit</span></button><button class="icon-btn delete" onclick="openDeleteModal(${index}, false)"><span class="material-icons-round">delete_outline</span></button></div></td><td><div class="status-pill ${stClass}" onclick="toggleStatus('${nf.id}', ${nf.corrigido})"><span class="material-icons-round" style="font-size:14px;">${stIcon}</span>${stText}</div></td><td><span class="badge ${badgeClass}">${nf.setor}</span></td><td>${nf.tipo}</td><td>${nf.fornecedor}</td><td>${nf.pedido||'-'}</td><td>${nf.linha_pedido||'-'}</td><td style="font-weight:600;">${nf.valor}</td><td>${formatDate(nf.emissao)}</td><td>${formatDate(nf.inclusao)}</td><td>${formatDate(nf.vencimento)}</td><td>${nf.referencia||'-'}</td><td>${nf.chave||'-'}</td><td>${nf.resp_correcao||'-'}</td><td class="text-long-col">${nf.obs_erro||''}</td><td class="text-long-col">${nf.obs_correcao||''}</td>`;
                tbody.appendChild(tr);
            });
            updateDashboard();
            initSortable();
        }

        function initSortable() {
            const el = document.getElementById('tableBody');
            if(el) {
                if(el._sortable) el._sortable.destroy();
                if(typeof Sortable !== 'undefined') {
                    el._sortable = Sortable.create(el, {
                        handle: '.drag-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: async function (evt) {
                            const item = nfs.splice(evt.oldIndex, 1)[0];
                            nfs.splice(evt.newIndex, 0, item);
                            const updates = nfs.map((nf, index) => ({ id: nf.id, ordem: index }));
                            await supabase.from('notas').upsert(updates, { onConflict: 'id' });
                        }
                    });
                }
            }
        }

        function filterServices(colIndex, val) { const table = document.getElementById("svcTable"); const tr = table.getElementsByTagName("tr"); const filter = val.toUpperCase(); for (let i = 1; i < tr.length; i++) { const td = tr[i].getElementsByTagName("td")[colIndex]; if (td) { const input = td.querySelector('input, select'); const txtValue = input ? input.value : td.textContent || td.innerText; if (txtValue.toUpperCase().indexOf(filter) > -1) tr[i].style.display = ""; else tr[i].style.display = "none"; } } }
        async function updateServiceData(id, field, value) { await supabase.from('servicos').update({ [field]: value }).eq('id', id); const row = servicesData.find(s => s.id === id); if(row) row[field] = value; }
        async function addServiceRow() { const { data, error } = await supabase.from('servicos').insert([{ fornecedor: '', envio_nf: 'PENDENTE', status_po: 'PENDENTE' }]).select(); if(!error && data) { servicesData.push(data[0]); renderServicesTable(); updateChecklistDashboard(); } }
        async function saveChecklistDate(val) { await supabase.from('checklist_config').upsert({ id: 1, titulo_data: val }); }
        
        async function openConsideracoes() { document.getElementById('notesModal').classList.add('active'); const {data}=await supabase.from('consideracoes').select('texto').eq('id',1).single(); if(data)document.getElementById('notesArea').value=data.texto; }
        function closeNotesModal() { document.getElementById('notesModal').classList.remove('active'); }
        async function saveNotes() { const txt=document.getElementById('notesArea').value; await supabase.from('consideracoes').upsert({id:1,texto:txt}); document.getElementById('notesStatus').innerText="Salvo!"; setTimeout(()=>document.getElementById('notesStatus').innerText="",2000); }

        function getStatusClass(val) { if(!val) return ''; const v = val.toUpperCase(); if(v==='PENDENTE'||v==='CORREÇÃO') return 'st-red'; if(v==='RECEBIDO'||v==='LANÇADO') return 'st-green'; if(v==='NÃO PRESTADO') return 'st-blue'; if(v==='APROVAÇÃO') return 'st-yellow'; return ''; }
        function formatDate(dt) { if(!dt) return '-'; return dt.split('T')[0].split('-').reverse().join('/'); }
        async function toggleStatus(id, current) { await supabase.from('notas').update({corrigido: !current}).eq('id', id); loadData(); }
        async function editRow(index) { const nf = nfs[index]; if(!nf) return; document.getElementById('editId').value = nf.id; document.getElementById('modalTitle').innerText = "Editar Nota"; document.getElementById('setor').value = nf.setor || ''; document.getElementById('tipo').value = nf.tipo || ''; document.getElementById('fornecedor').value = nf.fornecedor || ''; document.getElementById('valor').value = nf.valor || ''; document.getElementById('dataEmissao').value = nf.emissao || ''; document.getElementById('obsErro').value = nf.obs_erro || ''; document.getElementById('pedido').value = nf.pedido || ''; document.getElementById('linhaPedido').value = nf.linha_pedido || ''; document.getElementById('dataInclusao').value = nf.inclusao || ''; document.getElementById('dataVencimento').value = nf.vencimento || ''; document.getElementById('referencia').value = nf.referencia || ''; document.getElementById('chave').value = nf.chave || ''; document.getElementById('respCorrecao').value = nf.resp_correcao || ''; document.getElementById('obsCorrecao').value = nf.obs_correcao || ''; document.getElementById('modalOverlay').classList.add('active'); }
        document.getElementById('nfForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const id = document.getElementById('editId').value; const data = { setor:document.getElementById('setor').value, tipo:document.getElementById('tipo').value, fornecedor:document.getElementById('fornecedor').value, valor:document.getElementById('valor').value, emissao:document.getElementById('dataEmissao').value, obs_erro:document.getElementById('obsErro').value, pedido:document.getElementById('pedido').value, linha_pedido:document.getElementById('linhaPedido').value, inclusao:document.getElementById('dataInclusao').value||null, vencimento:document.getElementById('dataVencimento').value||null, referencia:document.getElementById('referencia').value, chave:document.getElementById('chave').value, resp_correcao:document.getElementById('respCorrecao').value, obs_correcao:document.getElementById('obsCorrecao').value }; if(id) await supabase.from('notas').update(data).eq('id', id); else await supabase.from('notas').insert([data]); closeModal(); loadData(); });
        document.getElementById('btnNovo').onclick=()=>{ document.getElementById('editId').value=""; document.getElementById('nfForm').reset(); document.getElementById('modalOverlay').classList.add('active'); };
        window.onclick=(e)=>{ if(e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); };
        
        function updateDashboard() {
            const map = { 'FISCAL':{c:0,t:0}, 'COMPRAS':{c:0,t:0}, 'ALMOXARIFADO':{c:0,t:0}, 'APROVAÇÃO':{c:0,t:0} };
            nfs.forEach(nf => { const s = nf.setor ? nf.setor.trim().toUpperCase() : 'OUTROS'; if (map[s]) { map[s].c++; map[s].t += parseFloat(String(nf.valor).replace(/[^\d.,]/g,'').replace('.','').replace(',','.')) || 0; } });
            
            document.getElementById('statsBox').innerHTML = Object.keys(map).map(key => { 
                const css = 'stat-'+key.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                return `<div class="stat-item ${css}"><span class="stat-label">${key}</span><span class="stat-count">${map[key].c}</span><span class="stat-value">R$ ${map[key].t.toLocaleString('pt-BR',{minimumFractionDigits:2})}</span></div>` 
            }).join('');
            
            const ctx = document.getElementById('sectorChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(map), datasets: [{ data: Object.values(map).map(m=>m.c), backgroundColor: ['#b45309','#b91c1c','#1d4ed8','#047857'], borderWidth:0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{display:false} } } });
        }

        function calculateKPIs() { const today=new Date(); today.setHours(0,0,0,0); const next10=new Date(today); next10.setDate(today.getDate()+10); const stats={merc:{0:{title:"NOTAS PENDENTES:",total:0,sectors:initSectors()},1:{title:"A VENCER (10 DIAS):",total:0,sectors:initSectors()},2:{title:"VENCIDAS:",total:0,sectors:initSectors()}},serv:{0:{title:"SERVIÇOS PENDENTES:",total:0,sectors:initSectors()},1:{title:"A VENCER (10 DIAS):",total:0,sectors:initSectors()},2:{title:"VENCIDAS:",total:0,sectors:initSectors()}}}; function initSectors(){return{'COMPRAS':{c:0,d:null,s:'-'},'FISCAL':{c:0,d:null,s:'-'},'APROVAÇÃO':{c:0,d:null,s:'-'},'ALMOXARIFADO':{c:0,d:null,s:'-'}};} nfs.forEach(nf=>{ const tk=nf.tipo==='MERCADORIA'?'merc':'serv'; const s=nf.setor ? nf.setor.trim().toUpperCase() : 'OUTROS'; if(!stats[tk][0].sectors[s]) return; const em=nf.emissao?new Date(nf.emissao+'T00:00:00'):null; const v=nf.vencimento?new Date(nf.vencimento+'T00:00:00'):null; updateStat(stats[tk][0],s,em,nf.fornecedor); if(v){ if(v>=today&&v<=next10) updateStat(stats[tk][1],s,em,nf.fornecedor); if(v<today) updateStat(stats[tk][2],s,em,nf.fornecedor); } }); function updateStat(o,sec,d,sup){ if(!o.sectors[sec])return; o.total++; o.sectors[sec].c++; if(d&&(!o.sectors[sec].d||d<o.sectors[sec].d)){o.sectors[sec].d=d; o.sectors[sec].s=sup;} } document.getElementById('colMercadoria').innerHTML=renderKPITables(stats.merc); document.getElementById('colServico').innerHTML=renderKPITables(stats.serv); const normalize = (str) => str ? str.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : ""; const checklistPendingCount = servicesData.filter(s => normalize(s.envio_nf).includes('PENDENTE')).length; document.getElementById('kpiChecklistCount').innerText = checklistPendingCount; }
        function renderKPITables(d){ let h=''; [0,1,2].forEach(i=>{const g=d[i]; h+=`<div class="kpi-table-wrapper"><div class="kpi-header-row"><span>${g.title}</span><span class="kpi-count-badge">${g.total}</span></div><table class="kpi-table"><tr><th>SETOR</th><th>QTD</th><th>DATA</th><th>FORN.</th></tr>`; ['COMPRAS','FISCAL','APROVAÇÃO','ALMOXARIFADO'].forEach((s,idx)=>{const r=g.sectors[s]; const ds=(r.c>0&&r.d)?r.d.toLocaleDateString('pt-BR'):'-'; h+=`<tr class="${idx%2===0?'kpi-row-grey':'kpi-row-fiscal'}"><td>${s}</td><td class="${r.c>0?'red-text':''}">${r.c}</td><td>${ds}</td><td>${r.c>0?r.s:'-'}</td></tr>`;}); h+=`</table></div>`;}); return h; }
        async function exportKPIPDF() { 
            if(!window.html2canvas || !window.jspdf) { alert("Bibliotecas PDF não carregaram."); return; }
            const element = document.getElementById('kpiContent');
            const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#f1f5f9' }); 
            const imgData = canvas.toDataURL('image/jpeg', 0.8); 
            const { jsPDF } = window.jspdf; 
            const pdf = new jsPDF('l', 'mm', 'a4'); 
            const imgProps = pdf.getImageProperties(imgData); 
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; 
            if (pdfHeight > pdf.internal.pageSize.getHeight()) { const ratio = pdf.internal.pageSize.getHeight() / pdfHeight; pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth * ratio, pdf.internal.pageSize.getHeight()); } 
            else { pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight); } 
            pdf.save('KPI_Dashboard.pdf'); 
        }
        function exportMainExcel() { const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(nfs); XLSX.utils.book_append_sheet(wb,ws,"Notas"); XLSX.writeFile(wb,"notas.xlsx"); }
        function processXML() { const xmlText=document.getElementById('xmlInput').value; const parser=new DOMParser(); const xmlDoc=parser.parseFromString(xmlText,"text/xml"); const emitNome=xmlDoc.getElementsByTagName("emit")[0]?.getElementsByTagName("xNome")[0]?.textContent||""; const vNF=xmlDoc.getElementsByTagName("vNF")[0]?.textContent||""; const dhEmi=xmlDoc.getElementsByTagName("dhEmi")[0]?.textContent||""; let chave=xmlDoc.getElementsByTagName("chNFe")[0]?.textContent||""; if(!chave){const infNFe=xmlDoc.getElementsByTagName("infNFe")[0]; if(infNFe)chave=infNFe.getAttribute("Id")?.replace("NFe","")||"";} const dup=xmlDoc.getElementsByTagName("dup")[0]; const dVenc=dup?dup.getElementsByTagName("dVenc")[0]?.textContent:""; document.getElementById('editId').value=""; document.getElementById('modalTitle').innerText="Revisar XML"; document.getElementById('fornecedor').value=emitNome; document.getElementById('valor').value=vNF; document.getElementById('chave').value=chave; document.getElementById('referencia').value=xmlDoc.getElementsByTagName("nNF")[0]?.textContent||""; if(dhEmi)document.getElementById('dataEmissao').value=dhEmi.split('T')[0]; if(dVenc)document.getElementById('dataVencimento').value=dVenc; else alert("Vencimento não encontrado."); document.getElementById('pedido').value=""; document.getElementById('linhaPedido').value=""; document.getElementById('obsErro').value=""; closeXMLModal(); document.getElementById('modalOverlay').classList.add('active'); }
    </script>
</body>
</html>